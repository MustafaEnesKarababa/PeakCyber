import * as signalR from "@microsoft/signalr"
import { getToken } from "@/api/token"

const API_BASE = process.env.NEXT_PUBLIC_API_BASE_URL || "http://localhost:7095/api"

const HUB_URL = API_BASE.replace(/\/api\/?/,'') + '/hubs/scanHub'


let connection: signalR.HubConnection | null = null;


export function getScanHubConnection() {
  if (!connection) {
    connection = new signalR.HubConnectionBuilder()
      .withUrl(HUB_URL, {
        accessTokenFactory: () => getToken() || "",
      })
      .withAutomaticReconnect()
      .configureLogging(signalR.LogLevel.Information)
      .build();
  }
  return connection;
}


export async function ensureHubStarted() {
  const conn = getScanHubConnection();
  if (conn.state === signalR.HubConnectionState.Disconnected) {
    await conn.start();
  }
  return conn;
}