using System.Security.Cryptography;
using System.Text;

public static class OperationIds
{
    public static Guid NewRunId() => Guid.NewGuid();
    public static Guid ProjectIdFromUserAndUrl(string userId, string targetUrl)
    {
        var payload = $"{userId}:{NormalizeUrl(targetUrl)}";
        using var sha = SHA256.Create();
        var hash = sha.ComputeHash(Encoding.UTF8.GetBytes(payload));
        var guidBytes = new byte[16];
        Array.Copy(hash, guidBytes, 16);
        return new Guid(guidBytes);
    }

    private static string NormalizeUrl(string url)
    {
        try
        {
            var u = new Uri(url);
            var host = u.Host.ToLowerInvariant();
            var scheme = "https"; 
            var path = u.AbsolutePath.TrimEnd('/');
            return $"{scheme}://{host}{path}";
        }
        catch
        {
            return url.Trim().ToLowerInvariant();
        }
    }
}
