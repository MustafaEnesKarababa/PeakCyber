using Microsoft.AspNetCore.SignalR;
using VulnerabilityTest.API.Hubs;
using VulnerabilityTest.Application.Services.Interfaces;

namespace VulnerabilityTest.API.Realtime
{
    public class ScanProgressHubAdapter : IScanProgress
    {
        private readonly IHubContext<ScanHub> _hubContext;

        public ScanProgressHubAdapter(IHubContext<ScanHub> hubContext)
        {
            _hubContext = hubContext;
        }

        public Task StageAsync(Guid RunId, string step, string message)
        {
            return
            _hubContext.Clients.Group($"scan-{RunId}")
                .SendAsync("Stage", new 
                {
                    RunId, 
                    step, 
                    message,
                    at = DateTime.UtcNow });
        }
        public Task CompletedAsync(Guid RunId, int scanId, string? message = null)
        {
            return
            _hubContext.Clients.Group($"scan-{RunId}")
                .SendAsync("Completed", new
                {
                    RunId,
                    scanId,
                    message,
                    at = DateTime.UtcNow
                });
        }

        public Task FailedAsync(Guid RunId, string errorMessage)
        {
            return
            _hubContext.Clients.Group($"scan-{RunId}")
                .SendAsync("Failed", new
                {
                    RunId,
                    error = errorMessage,
                    at = DateTime.UtcNow
                });
        }

    }
}
